FROM python:3.11-slim

# Install required packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    openssh-client \
    curl \
    gnupg2 \
    ca-certificates \
    lsb-release \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install fly CLI - need to download the Linux ARM64 version
RUN mkdir -p /tmp/fly && \
    curl -Lo /tmp/fly/fly.tgz https://github.com/concourse/concourse/releases/download/v7.9.1/fly-7.9.1-linux-amd64.tgz && \
    tar -xzf /tmp/fly/fly.tgz -C /usr/local/bin && \
    chmod +x /usr/local/bin/fly && \
    rm -rf /tmp/fly

# Set up directories
WORKDIR /app
RUN mkdir -p /root/git /test-results

# Install pipeline-helpers
COPY . /app/

# Copy test scripts and set permissions
COPY scripts/run-tests.sh /app/scripts/
COPY e2e_tests/ /app/e2e_tests/

# Make sure script is executable - using explicit chmod with full path
RUN chmod +x /app/scripts/run-tests.sh && \
    ls -la /app/scripts/run-tests.sh && \
    pip install -e .

# Create SSH directory for git cloning
RUN mkdir -p /root/.ssh && \
    chmod 700 /root/.ssh

CMD ["/app/scripts/run-tests.sh"]